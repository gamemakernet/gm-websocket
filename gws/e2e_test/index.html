<style>
  body {
    background: #222;
    color: #ddd;
    font-family: Arial, Helvetica, sans-serif;
  }

  .logo {
    color: dodgerblue;
  }
</style>

<h3>
  <pre class="logo">  ________   __      __    _________
  /  _____/  /  \    /  \  /   _____/
  /   \  ___  \   \/\/   /  \_____  \ 
  \    \_\  \  \        /   /        \
  \______  /   \__/\  /   /_______  /
         \/         \/            \/ </pre>

  E2E Testing
</h3>
<p>
  <button onclick="testCreateLobby()">Create lobby</button>
  <button onclick="testCreateLobbyWithPsw()">Create lobby with password</button>
</p>
<p>
  <button onclick="testJoinLobby()">Join lobby</button>
  <button onclick="testJoinLobbyWithPsw()">Join lobby with password</button>
</p>
<p><button onclick="testAutoJoinLobby()">Auto join lobby</button></p>
<p><button onclick="testLeaveLobby()">Leave lobby</button></p>
<p><button onclick="testListLobbies()">List lobbies</button></p>
<p><button onclick="testLobbyTransferAdmin()">Transfer lobby admin</button></p>
<p><button onclick="testSetAllowJoin()">Set allow join</button></p>
<p><button onclick="testSetMaxPlayers()">Set max players</button></p>
<p>
  <button onclick="testKickPlayer()">Kick player</button>
  <button onclick="testBanPlayer()">Ban player</button>
</p>
<p><button onclick="testSendMessage()">Send message</button></p>

<script src="lib.js"></script>

<script>
  let timeStart
  let ws
  let send

  // WebSocket
  function connect() {
    timeStart = new Date()
    ws = new WebSocket("ws://localhost:8080")
    // ws = new WebSocket("wss://heroku-test-poll.herokuapp.com")
    ws.binaryType = 'arraybuffer'
    send = sendBuffer.bind(null, ws)

    ws.onopen = () => {
      console.log(`%c🛈 Connection established in ${time()}`, "color: lime")
    }

    ws.onclose = () => {
      console.log("%c⚠️ Connection failed or lost. Attempt to reconnect in 2 seconds", "color: red")
      setTimeout(connect, 2000);
    }

    ws.onmessage = ({ data }) => {
      const array = decodeMessage(data)
      console.log(`On event '${Object.keys(commands)[array[0]]}':`, array)

      switch (array[0]) {
        case commands.error:
          error(array[1])
          break

        case commands.lobby_create:
          if (array[1]) { error(array[1]); break }
          console.log(`Lobby created in ${time()}. ID: ${array[2]}`)
          break;

        case commands.lobby_leave:
          if (array[1]) { error(array[1]); break }
          console.log(`Lobby left in ${time()}. ID: ${array[1]}`)
          break;

        case commands.lobby_list:
          console.log(`Lobby list in ${time()} ${array.length === 1 ? ". No lobbies found" : ""}`)

          // const lobbies = []
          while (offset < array.length - 1) {

          }
          // if (array.length > 1) {

          //   let str = from_u32(offset)
          //   lobbies.push(lobby)
          // }
          // console.log(`Lobbies: ${lobbies}`)
          break;

        case commands.game_message:
          const str = String.fromCharCode.apply(null, new Uint8Array(array.slice(2)));
          console.log(`Received message: ${str}`)
          break

        case commands.lobby_allow_join:
          if (array[1]) { error(array[1]); break }
          console.log(`Set lobby allowJoin in ${time()}`)
          break

        case commands.lobby_max_players:
          if (array[1]) { error(array[1]); break }
          console.log(`Set lobby maxPlayers in ${time()}`)
          break

        case commands.lobby_join:
          if (array[1]) { error(array[1]); break }
          console.log(`Lobby joined in ${time()}`)
          break

        case commands.lobby_transfer:
          if (array[1]) { error(array[1]); break }
          console.log(`Lobby admin transfered in ${time()}`)
          break

        case commands.lobby_kick:
          if (array[1]) { error(array[1]); break }
          console.log(`${!array[3] ? "Kicked" : "Banned"} player in ${time()}`)
          break

        case commands.lobby_player_joined:
          console.log(`Player has joined`)
          break

        case commands.lobby_player_left:
          console.log(`Player has left`)
          break

        case commands.lobby_allow_join_changed:
          console.log(`Admin has set lobby allowJoin flag`)
          break

        case commands.lobby_max_players_changed:
          console.log(`Admin has set lobby maxPlayers flag`)
          break

        case commands.lobby_player_kicked:
          console.log(`${!array[2] ? "Kicked" : "Banned"} player. ID: ${array[1]}`)
          break
      }
      console.log('---');
    }
  }

  // Functions
  function testCreateLobby() {
    console.log("%cCreating lobby..", "color: dodgerblue")
    timeStart = Date.now()
    send(commands.lobby_create, ...string("Lobby"), 32, ...string("John"))
  }

  function testCreateLobbyWithPsw() {
    console.log("%cCreating lobby with password..", "color: dodgerblue")
    timeStart = Date.now()
    // send(commands.lobby_create, ...string("Lobby"), 32, ...string("John"), ...string("password"))
    send(commands.lobby_create, ...string("lobby1"), 3, ...string("gino"), ...string(""), 0)
  }

  function testSendMessage() {
    console.log("%cSending message..", "color: dodgerblue")
    timeStart = Date.now()
    send(commands.game_message, 1, ...string("Hello world!"))
  }

  function testSetAllowJoin() {
    console.log("%cSetting lobby flag: allowJoin..", "color: dodgerblue")
    timeStart = Date.now()
    send(commands.lobby_allow_join, 1)
  }

  function testSetMaxPlayers() {
    console.log("%cSetting lobby flag: maxPlayers..", "color: dodgerblue")
    timeStart = Date.now()
    send(commands.lobby_max_players, 8)
  }

  function testLeaveLobby() {
    console.log("%cLeaving lobby..", "color: dodgerblue")
    timeStart = Date.now()
    send(commands.lobby_leave)
  }

  function testListLobbies() {
    console.log("%cGetting the lobby list..", "color: dodgerblue")
    timeStart = Date.now()
    send(commands.lobby_list)
  }

  function testJoinLobby() {
    console.log("%cJoining the lobby..", "color: dodgerblue")
    timeStart = Date.now()
    send(commands.lobby_join, ...string("Harry"), ...u32(0))
  }

  function testJoinLobbyWithPsw() {
    console.log("%cJoining the lobby with password..", "color: dodgerblue")
    timeStart = Date.now()
    send(commands.lobby_join, ...string("Harry"), ...u32(0), ...string("password"))
  }

  function testAutoJoinLobby() {
    console.log("%cAuto joining a lobby..", "color: dodgerblue")
    timeStart = Date.now()
    send(commands.lobby_join_auto, 1, 1, ...string("Harry"))
  }

  function testLobbyTransferAdmin() {
    console.log("%cTransfer lobby admin to player 1..", "color: dodgerblue")
    timeStart = Date.now()
    send(commands.lobby_transfer, 1)
  }

  function testKickPlayer() {
    console.log("%cKicking player..", "color: dodgerblue")
    timeStart = Date.now()
    send(commands.lobby_kick, 1, 0)
  }

  function testBanPlayer() {
    console.log("%cBanning player..", "color: dodgerblue")
    timeStart = Date.now()
    send(commands.lobby_kick, 1, 1)
  }

  connect()
</script>
